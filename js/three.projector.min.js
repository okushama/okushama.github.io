THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){function e(){if(l===x){var e=new THREE.RenderableObject;return d.push(e),x++,l++,e}return d[l++]}function t(){if(p===T){var e=new THREE.RenderableVertex;return y.push(e),T++,p++,e}return y[p++]}function r(){if(u===g){var e=new THREE.RenderableFace;return H.push(e),g++,u++,e}return H[u++]}function i(){if(v===b){var e=new THREE.RenderableLine;return w.push(e),b++,v++,e}return w[v++]}function n(){if(m===S){var e=new THREE.RenderableSprite;return M.push(e),S++,m++,e}return M[m++]}function o(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function a(e,t){var r=0,i=1,n=e.z+e.w,o=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return n>=0&&o>=0&&a>=0&&s>=0?!0:0>n&&0>o||0>a&&0>s?!1:(0>n?r=Math.max(r,n/(n-o)):0>o&&(i=Math.min(i,n/(n-o))),0>a?r=Math.max(r,a/(a-s)):0>s&&(i=Math.min(i,a/(a-s))),r>i?!1:(e.lerp(t,r),t.lerp(e,1-i),!0))}var s,l,c,p,E,u,h,v,f,m,R,d=[],x=0,y=[],T=0,H=[],g=0,w=[],b=0,M=[],S=0,z={objects:[],lights:[],elements:[]},V=new THREE.Vector3,j=new THREE.Vector4,L=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),C=new THREE.Box3,k=new Array(3),N=(new Array(4),new THREE.Matrix4),W=new THREE.Matrix4,B=new THREE.Matrix4,F=new THREE.Matrix3,P=new THREE.Frustum,I=new THREE.Vector4,O=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var D=function(){var e=[],n=[],o=null,a=null,s=new THREE.Matrix3,l=function(t){o=t,a=o.material,s.getNormalMatrix(o.matrixWorld),e.length=0,n.length=0},p=function(e){var t=e.position,r=e.positionWorld,i=e.positionScreen;r.copy(t).applyMatrix4(R),i.copy(r).applyMatrix4(W);var n=1/i.w;i.x*=n,i.y*=n,i.z*=n,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1},u=function(e,r,i){c=t(),c.position.set(e,r,i),p(c)},v=function(t,r,i){e.push(t,r,i)},f=function(e,t){n.push(e,t)},m=function(e,t,r){return e.visible===!0||t.visible===!0||r.visible===!0?!0:(k[0]=e.positionScreen,k[1]=t.positionScreen,k[2]=r.positionScreen,L.isIntersectionBox(C.setFromPoints(k)))},d=function(e,t,r){return(r.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(r.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0},x=function(e,t){var r=y[e],n=y[t];h=i(),h.id=o.id,h.v1.copy(r),h.v2.copy(n),h.z=(r.positionScreen.z+n.positionScreen.z)/2,h.material=o.material,z.elements.push(h)},T=function(t,i,l){var c=y[t],p=y[i],u=y[l];if(m(c,p,u)!==!1&&(a.side===THREE.DoubleSide||d(c,p,u)===!0)){E=r(),E.id=o.id,E.v1.copy(c),E.v2.copy(p),E.v3.copy(u),E.z=(c.positionScreen.z+p.positionScreen.z+u.positionScreen.z)/3;for(var h=0;3>h;h++){var v=3*arguments[h],f=E.vertexNormalsModel[h];f.set(e[v],e[v+1],e[v+2]),f.applyMatrix3(s).normalize();var R=2*arguments[h],x=E.uvs[h];x.set(n[R],n[R+1])}E.vertexNormalsLength=3,E.material=o.material,z.elements.push(E)}};return{setObject:l,projectVertex:p,checkTriangleVisibility:m,checkBackfaceCulling:d,pushVertex:u,pushNormal:v,pushUv:f,pushLine:x,pushTriangle:T}},G=new D;this.projectScene=function(c,d,x,T){u=0,v=0,m=0,z.elements.length=0,c.autoUpdate===!0&&c.updateMatrixWorld(),void 0===d.parent&&d.updateMatrixWorld(),N.copy(d.matrixWorldInverse.getInverse(d.matrixWorld)),W.multiplyMatrices(d.projectionMatrix,N),P.setFromMatrix(W),l=0,z.objects.length=0,z.lights.length=0,c.traverseVisible(function(t){if(t instanceof THREE.Light)z.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===!1)return;(t.frustumCulled===!1||P.intersectsObject(t)===!0)&&(s=e(),s.id=t.id,s.object=t,V.setFromMatrixPosition(t.matrixWorld),V.applyProjection(W),s.z=V.z,z.objects.push(s))}}),x===!0&&z.objects.sort(o);for(var H=0,g=z.objects.length;g>H;H++){var w=z.objects[H].object,b=w.geometry;if(G.setObject(w),R=w.matrixWorld,p=0,w instanceof THREE.Mesh){if(b instanceof THREE.BufferGeometry){var M=b.attributes,S=b.offsets;if(void 0===M.position)continue;for(var L=M.position.array,C=0,k=L.length;k>C;C+=3)G.pushVertex(L[C],L[C+1],L[C+2]);if(void 0!==M.normal)for(var D=M.normal.array,C=0,k=D.length;k>C;C+=3)G.pushNormal(D[C],D[C+1],D[C+2]);if(void 0!==M.uv)for(var U=M.uv.array,C=0,k=U.length;k>C;C+=2)G.pushUv(U[C],U[C+1]);if(void 0!==M.index){var A=M.index.array;if(S.length>0)for(var H=0;H<S.length;H++)for(var q=S[H],J=q.index,C=q.start,k=q.start+q.count;k>C;C+=3)G.pushTriangle(A[C]+J,A[C+1]+J,A[C+2]+J);else for(var C=0,k=A.length;k>C;C+=3)G.pushTriangle(A[C],A[C+1],A[C+2])}else for(var C=0,k=L.length/3;k>C;C+=3)G.pushTriangle(C,C+1,C+2)}else if(b instanceof THREE.Geometry){var K=b.vertices,Q=b.faces,X=b.faceVertexUvs[0];F.getNormalMatrix(R);for(var Y=w.material,Z=Y instanceof THREE.MeshFaceMaterial,$=Z===!0?w.material:null,_=0,et=K.length;et>_;_++){var tt=K[_];if(V.copy(tt),Y.morphTargets===!0)for(var rt=b.morphTargets,it=w.morphTargetInfluences,nt=0,ot=rt.length;ot>nt;nt++){var at=it[nt];if(0!==at){var st=rt[nt],lt=st.vertices[_];V.x+=(lt.x-tt.x)*at,V.y+=(lt.y-tt.y)*at,V.z+=(lt.z-tt.z)*at}}G.pushVertex(V.x,V.y,V.z)}for(var ct=0,pt=Q.length;pt>ct;ct++){var Et=Q[ct],Y=Z===!0?$.materials[Et.materialIndex]:w.material;if(void 0!==Y){var ut=Y.side,ht=y[Et.a],vt=y[Et.b],ft=y[Et.c];if(G.checkTriangleVisibility(ht,vt,ft)!==!1){var mt=G.checkBackfaceCulling(ht,vt,ft);if(ut!==THREE.DoubleSide){if(ut===THREE.FrontSide&&mt===!1)continue;if(ut===THREE.BackSide&&mt===!0)continue}E=r(),E.id=w.id,E.v1.copy(ht),E.v2.copy(vt),E.v3.copy(ft),E.normalModel.copy(Et.normal),mt!==!1||ut!==THREE.BackSide&&ut!==THREE.DoubleSide||E.normalModel.negate(),E.normalModel.applyMatrix3(F).normalize();for(var Rt=Et.vertexNormals,dt=0,xt=Math.min(Rt.length,3);xt>dt;dt++){var yt=E.vertexNormalsModel[dt];yt.copy(Rt[dt]),mt!==!1||ut!==THREE.BackSide&&ut!==THREE.DoubleSide||yt.negate(),yt.applyMatrix3(F).normalize()}E.vertexNormalsLength=Rt.length;var Tt=X[ct];if(void 0!==Tt)for(var Ht=0;3>Ht;Ht++)E.uvs[Ht].copy(Tt[Ht]);E.color=Et.color,E.material=Y,E.z=(ht.positionScreen.z+vt.positionScreen.z+ft.positionScreen.z)/3,z.elements.push(E)}}}}}else if(w instanceof THREE.Line){if(b instanceof THREE.BufferGeometry){var M=b.attributes;if(void 0!==M.position){for(var L=M.position.array,C=0,k=L.length;k>C;C+=3)G.pushVertex(L[C],L[C+1],L[C+2]);if(void 0!==M.index)for(var A=M.index.array,C=0,k=A.length;k>C;C+=2)G.pushLine(A[C],A[C+1]);else for(var gt=w.mode===THREE.LinePieces?2:1,C=0,k=L.length/3-1;k>C;C+=gt)G.pushLine(C,C+1)}}else if(b instanceof THREE.Geometry){B.multiplyMatrices(W,R);var K=w.geometry.vertices;if(0===K.length)continue;ht=t(),ht.positionScreen.copy(K[0]).applyMatrix4(B);for(var gt=w.mode===THREE.LinePieces?2:1,_=1,et=K.length;et>_;_++)ht=t(),ht.positionScreen.copy(K[_]).applyMatrix4(B),(_+1)%gt>0||(vt=y[p-2],I.copy(ht.positionScreen),O.copy(vt.positionScreen),a(I,O)===!0&&(I.multiplyScalar(1/I.w),O.multiplyScalar(1/O.w),h=i(),h.id=w.id,h.v1.positionScreen.copy(I),h.v2.positionScreen.copy(O),h.z=Math.max(I.z,O.z),h.material=w.material,w.material.vertexColors===THREE.VertexColors&&(h.vertexColors[0].copy(w.geometry.colors[_]),h.vertexColors[1].copy(w.geometry.colors[_-1])),z.elements.push(h)))}}else if(w instanceof THREE.Sprite){j.set(R.elements[12],R.elements[13],R.elements[14],1),j.applyMatrix4(W);var wt=1/j.w;j.z*=wt,j.z>=-1&&j.z<=1&&(f=n(),f.id=w.id,f.x=j.x*wt,f.y=j.y*wt,f.z=j.z,f.object=w,f.rotation=w.rotation,f.scale.x=w.scale.x*Math.abs(f.x-(j.x+d.projectionMatrix.elements[0])/(j.w+d.projectionMatrix.elements[12])),f.scale.y=w.scale.y*Math.abs(f.y-(j.y+d.projectionMatrix.elements[5])/(j.w+d.projectionMatrix.elements[13])),f.material=w.material,z.elements.push(f))}}return T===!0&&z.elements.sort(o),z}};
