var mvr=function(){String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)};var e=this;this.load_model_from_url=function(t,a){JSZipUtils.getBinaryContent(a,function(n,r){if(n)throw n;var o=new JSZip(r);e.render_model(a,t,o)})},this.render_model=function(e,t,a){function n(e){return JSON.stringify(jQuery.xml2json(e))}function r(){function e(e,t){var a=new THREE.DirectionalLight(15856113,.7);return a.position.set(e,1,t).normalize(),f.add(a),a}function a(e,t,a,n,r,o,i,s,l,p,u,c,d,E,m,y,w,g){function j(e,t,a,n){jQuery("#statspanel").append("<td>"+e+"</td>"),jQuery("#statspanel").append("<td>"+x.replace("%REP%",t)+"</td>"),jQuery("#statspanel").append("<td>"+x.replace("%REP%",a)+"</td>"),"undefined"!=typeof n&&jQuery("#statspanel").append("<td>"+x.replace("%REP%",n)+"</td>")}function H(e,t,a){var n=E,s=m,l=r,p=o;0==e&&(n=n+i+r,s+=i,l=i),1==e&&(n=n,s+=i,l=i),2==e&&(n+=i,s=s-o+i,l=r,p=i),3==e&&(n+=i+r,s=s-o+i,l=r,p=i),4==e&&(n+=i,s+=i),5==e&&(n=n+2*i+r,s+=i),s=z-s;var u=n/P,c=s/z-o/z;part=[new THREE.Vector2(u,c+p/z),new THREE.Vector2(u,c),new THREE.Vector2(u+l/P,c),new THREE.Vector2(u+l/P,c+p/z)],h.faceVertexUvs[0][t]=[part[0],part[1],part[3]],h.faceVertexUvs[0][a]=[part[1],part[2],part[3]]}jQuery("#statspanel").append("<p><strong>"+e+"</strong></p>");var x="<input type='text' value='%REP%' disabled/>";jQuery("#statspanel").append("<table>"),jQuery("#statspanel").append("<tr>"+j("Position",t,a,n)+"</tr>"),jQuery("#statspanel").append("<tr>"+j("Size",r,o,i)+"</tr>"),jQuery("#statspanel").append("<tr>"+j("Offset",u,c,d)+"</tr>"),jQuery("#statspanel").append("<tr>"+j("Rotation",s,l,p)+"</tr>"),jQuery("#statspanel").append("<tr>"+j("Scale",y,w,g)+"</tr>"),jQuery("#statspanel").append("<tr>"+j("Texture Offset",E,m)+"</tr>"),jQuery("#statspanel").append("</table>"),jQuery("#statspanel").append("<br><br>"),h=new THREE.BoxGeometry(r*y,o*w,i*g,1,1,1),b&&R?T=new THREE.MeshPhongMaterial({color:3355443,wireframe:!0}):(T=new THREE.MeshBasicMaterial({color:3355443,wireframe:!0}),T=new THREE.MeshPhongMaterial({map:v,side:THREE.DoubleSide,transparent:!0,opacity:1,overdraw:0}),T.overdraw=1),H(0,2,3),H(1,0,1),H(2,4,5),H(3,6,7),H(4,10,11),H(5,8,9),h.applyMatrix((new THREE.Matrix4).makeTranslation((r/2+u)*y,-(c+o/2)*w,(i/2+d)*g));var M=new THREE.Mesh(h,T);M.position.x=t,M.position.y=a,M.position.z=n,M.rotation.order="ZYX",M.rotation.z=-Math.radians(p),M.rotation.y=Math.radians(l),M.rotation.x=-Math.radians(s),M.textureObj=v,M.cubename=e,f.add(M)}function n(e,t,a,n){var r=new THREE.PlaneBufferGeometry(e,t,a),o=THREE.ImageUtils.loadTexture("grid.png");o.wrapS=THREE.ClampToEdgeWrapping,o.wrapT=THREE.ClampToEdgeWrapping,o.magFilter=THREE.LinearFilter,o.minFilter=THREE.LinearFilter,o.needsUpdate=!0;var i=new THREE.MeshPhongMaterial({color:n,side:THREE.DoubleSide,opacity:1,overdraw:1,transparent:!0,map:o}),s=new THREE.Mesh(r,i);s.rotation.x=Math.radians(90),s.position.y-=25,f.add(s)}var r=jQuery(t),o={antialias:!0,stencil:!1};E=new THREE.WebGLRenderer(o),E.setClearColor(16777215,1),E.setSize(r.width(),r.height());var w=jQuery(E.domElement);jQuery(t).bind("mousewheel",function(e){e.originalEvent.wheelDelta<0?u--:u++,e.preventDefault()}),jQuery(document).bind("keydown",function(e){e.phase>2||87==e.which&&(R=!R,g=y.length)}),jQuery(t).bind("mouseup",function(e){var a=new THREE.Vector3(e.clientX/jQuery(t).width()*2-1,2*-(e.clientY/jQuery(t).height())+1,.5);H.unprojectVector(a,d);var n=new THREE.Raycaster(d.position,a.sub(d.position).normalize()),r=[];f.traverse(function(e){e instanceof THREE.Mesh&&r.push(e)});var o=n.intersectObjects(r);if(o.length>0){var i=o[0].object;c=i.cubename,console.info(c),"undefined"!=typeof c&&(jQuery("p").css({background:"transparent",color:"black"}),jQuery("p:contains('"+c+"')").css({background:"black",color:"white"})[0].scrollIntoView(!0),jQuery(document).scrollTop(0))}else c=""}),jQuery(document).bind("mousemove",t,function(e){M&&(x=e.pageX)}),d=new THREE.PerspectiveCamera(75,r.width()/r.height(),1,1e4),d.position.z=-40,d.rotation.x=180,f=new THREE.Scene;e(0,3);e(0,-3),e(3,0),e(-3,0),m=new THREE.OrbitControls(d);var b=!0;if(null!=i.file(""==j?"texture.png":j)){b=!1;var Q=String.fromCharCode.apply(null,new Uint16Array(i.file(""==j?"texture.png":j).asUint8Array())),F=window.btoa(Q),S="data:image/png;base64,"+F,O=new Image;O.onload=function(){v.image=O,v.wrapS=THREE.RepeatWrapping,v.wrapT=THREE.RepeatWrapping,v.magFilter=THREE.NearestFilter,v.minFilter=THREE.NearestFilter,v.needsUpdate=!0},O.src=S}for(var P=l,z=p,C=0;C<y.length;C++){var U=y[C];1==s?(console.info("Creating object based off of xml techne!"),console.info(U),U.Position=U.Position.split(","),U.Size=U.Size.split(","),U.Rotation=U.Rotation.split(","),U.Offset=U.Offset.split(","),U.TextureOffset=U.TextureOffset.split(","),a(U.name,parseFloat(U.Position[0]),-parseFloat(U.Position[1]),parseFloat(U.Position[2]),parseFloat(U.Size[0]),parseFloat(U.Size[1]),parseFloat(U.Size[2]),parseFloat(U.Rotation[0]),parseFloat(U.Rotation[1]),parseFloat(U.Rotation[2]),parseFloat(U.Offset[0]),parseFloat(U.Offset[1]),parseFloat(U.Offset[2]),parseFloat(U.TextureOffset[0]),parseFloat(U.TextureOffset[1]),1,1,1)):a(U.name,U.position[0],-U.position[1],U.position[2],U.dimensions[0],U.dimensions[1],U.dimensions[2],U.rotation[0],U.rotation[1],U.rotation[2],U.offset[0],U.offset[1],U.offset[2],U.txOffset[0],U.txOffset[1],U.scale[0],U.scale[1],U.scale[2])}n(112.5,112.5,20,15856113),jQuery(t).append(w)}function o(){requestAnimationFrame(o),f.traverse(function(e){e instanceof THREE.Mesh&&(e.cubename==c?e.material.opacity=1:e.material.opacity>.5&&(e.material.opacity-=.04),(""==c||"undefined"==typeof c)&&(e.material.opacity=1),R?g>0&&(e.material=null,e.material=new THREE.MeshPhongMaterial({color:3355443,wireframe:!0}),e.material.needsUpdate=!0,g--):g>0&&(g--,e.material=new THREE.MeshLambertMaterial({map:v,transparent:!0,opacity:1,overdraw:1,side:THREE.DoubleSide})))});M&&(b>x?w+=.005:w-=.005),E.render(f,d),m.update()}var i=a,s=e.endsWith(".tbl")?0:1;1==s&&(null!=i.file("model.json")?(console.info("Found json techne format!"),s=2):null!=i.file("model.xml")?console.info("Found xml techne format!"):(console.info("Unsupported type or incorrectly packaged?"),s=-1));var l,p,u=30,c="";Math.degrees=function(e){return 180*e/Math.PI},Math.radians=function(e){return e*(Math.PI/180)};var d,f,E,m,h,T,y=[],w=30,R=!1,g=0,v=new THREE.Texture,j="",H=new THREE.Projector;jQuery(function(){var e=0==s||2==s?i.file("model.json").asText():1==s?n(i.file("model.xml").asText()):"null",t=JSON.parse(e);jQuery("#statspanel").append(1==s?"<p>Techne (XML) Model</p>":"<p>Tabula Model</p>");$.each(t,function(e,t){1==s?"Models"==e&&$.each(t,function(e,t){"Model"==e&&$.each(t,function(e,t){if("Geometry"==e&&$.each(t,function(e,t){"Shape"==e&&$.each(t,function(e,t){y.push(t)})}),"TextureSize"==e){console.info(["TextureSize",t]);var a=t.split(",");l=a[0],p=a[1]}"texture"==e&&(console.info(["Texture",t]),j=t)})}):"cubes"==e&&$.each(t,function(e,t){y.push(t)}),"textureWidth"==e&&(l=t),"textureHeight"==e&&(p=t)}),setTimeout(function(){r(),o()},100)});var x=-1,b=-1,M=!1}},ModelViewer=new mvr;
