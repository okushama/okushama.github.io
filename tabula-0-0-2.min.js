var tbl=function(){this.render_model=function(e,t){JSZipUtils.getBinaryContent(t,function(t,n){function a(e){return"string"!=typeof e&&(e=JSON.stringify(e,null,"  ")),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})}function r(){function t(e,t){var n=new THREE.DirectionalLight(15856113,.7);n.position.set(e,1,t).normalize(),c.add(n)}function n(e,t,n,a,r,o,s,l,p,u,E,m,h,T,g){function H(e,t,n){var a=T,i=g,l=r,p=o;0==e&&(a=a+s+r,i+=s,l=s),1==e&&(a=a,i+=s,l=s),2==e&&(a+=s,i=i-o+s,l=r,p=s),3==e&&(a+=s+r,i=i-o+s,l=r,p=s),4==e&&(a+=s,i+=s),5==e&&(a=a+2*s+r,i+=s),i=j-i;var u=a/x,c=i/j-o/j;part=[new THREE.Vector2(u,c+p/j),new THREE.Vector2(u,c),new THREE.Vector2(u+l/x,c),new THREE.Vector2(u+l/x,c+p/j)],f.faceVertexUvs[0][t]=[part[0],part[1],part[3]],f.faceVertexUvs[0][n]=[part[1],part[2],part[3]]}f=new THREE.BoxGeometry(r,o,s,1,1,1),i&&w?d=new THREE.MeshBasicMaterial({color:0,wireframe:!0}):(d=new THREE.MeshBasicMaterial({color:0,wireframe:!0}),d=new THREE.MeshPhongMaterial({map:R,opacity:1,overdraw:0}),d.overdraw=1),H(0,2,3),H(1,0,1),H(2,4,5),H(3,6,7),H(4,10,11),H(5,8,9),f.applyMatrix((new THREE.Matrix4).makeTranslation(r/2+E,-(m+o/2),s/2+h));var v=new THREE.Mesh(f,d);v.position.x=t,v.position.y=n,v.position.z=a,v.rotation.order="ZYX",v.rotation.z=-Math.radians(u),v.rotation.y=Math.radians(p),v.rotation.x=-Math.radians(l),v.textureObj=R,v.cubename=e,c.add(v)}function a(e,t,n,a){var r=new THREE.PlaneGeometry(e,t,n),i=THREE.ImageUtils.loadTexture("grid.png");i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,i.magFilter=THREE.LinearFilter,i.minFilter=THREE.LinearFilter,i.needsUpdate=!0;var o=new THREE.MeshBasicMaterial({color:a,side:THREE.DoubleSide,wireframe:!1,transparent:!0,map:i}),s=new THREE.Mesh(r,o);s.rotation.x=Math.radians(90),s.position.y-=25,c.add(s)}var r=jQuery(e);jQuery(e).bind("mousewheel",function(e){e.originalEvent.wheelDelta<0?p--:p++,e.preventDefault()}),jQuery(document).bind("keyup",function(e){87==e.which&&(w=!w,T=m.length)}),jQuery(e).bind("mouseup",function(t){var n=new THREE.Vector3(t.clientX/jQuery(e).width()*2-1,2*-(t.clientY/jQuery(e).height())+1,.5);g.unprojectVector(n,u);var a=new THREE.Raycaster(u.position,n.sub(u.position).normalize()),r=[];c.traverse(function(e){e instanceof THREE.Mesh&&r.push(e)});var i=a.intersectObjects(r);if(i.length>0){var o=i[0].object;jQuery(".string:contains('"+o.cubename+"')")[0].scrollIntoView(!0),jQuery(document).scrollTop(0)}}),jQuery(document).bind("mousemove",e,function(e){y&&(H=e.pageX)}),u=new THREE.PerspectiveCamera(75,r.width()/r.height(),1,1e4),u.position.z=1e3,c=new THREE.Scene,t(0,3),t(0,-3),t(3,0),t(-3,0);var i=!0;if(null!=l.file("texture.png")){i=!1;var h=String.fromCharCode.apply(null,new Uint16Array(l.file("texture.png").asUint8Array())),v=window.btoa(h),M="data:image/png;base64,"+v,b=new Image;b.onload=function(){R.image=b,R.wrapS=THREE.RepeatWrapping,R.wrapT=THREE.RepeatWrapping,R.magFilter=THREE.NearestFilter,R.minFilter=THREE.NearestFilter,R.needsUpdate=!0},b.src=M}for(var x=o,j=s,Q=0;Q<m.length;Q++){var S=m[Q];n(S.name,S.position[0],-S.position[1],S.position[2],S.dimensions[0],S.dimensions[1],S.dimensions[2],S.rotation[0],S.rotation[1],S.rotation[2],S.offset[0],S.offset[1],S.offset[2],S.txOffset[0],S.txOffset[1])}a(112.5,112.5,20,15856113);var z={antialias:!0};E=new THREE.WebGLRenderer(z),E.setClearColor(16777215,1),E.setSize(r.width(),r.height());var F=jQuery(E.domElement);jQuery(e).append(F)}function i(){requestAnimationFrame(i),c.traverse(function(e){e instanceof THREE.Mesh&&(w?T>0&&(e.material=null,e.material=new THREE.MeshBasicMaterial({color:0,wireframe:!0}),e.material.needsUpdate=!0,T--):T>0&&(T--,e.material=new THREE.MeshLambertMaterial({map:R,opacity:1,overdraw:0})))});var e=p,t=1;h-=.002,y&&(v>H?h+=.005:h-=.005),u.position.y=15,u.position.x=c.position.x+e*Math.cos(t*h),u.position.z=c.position.z+e*Math.sin(t*h),u.lookAt(c.position),E.render(c,u)}if(t)throw t;var o,s,l=new JSZip(n),p=30;Math.degrees=function(e){return 180*e/Math.PI},Math.radians=function(e){return e*(Math.PI/180)};var u,c,E,f,d,m=[],h=30,w=!1,T=0,R=new THREE.Texture,g=new THREE.Projector;jQuery(function(){var e=l.file("model.json").asText(),t=JSON.parse(e);jQuery("#statspanel").html(a(t));$.each(t,function(e,t){"cubes"==e&&$.each(t,function(e,t){m.push(t)}),"textureWidth"==e&&(o=t),"textureHeight"==e&&(s=t)}),setTimeout(function(){r(),i()},100)});var H=-1,v=-1,y=!1})}},Tabula=new tbl;
