var tbl=function(){this.render_model=function(e,t){JSZipUtils.getBinaryContent(t,function(t,n){function r(e){return"string"!=typeof e&&(e=JSON.stringify(e,null,"  ")),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})}function a(){function t(e,t){var n=new THREE.DirectionalLight(16777215,.7);n.position.set(e,1,t).normalize(),p.add(n)}function n(e,t,n,r,i,o,s,u,l,c,E,m,h,v,g){function R(e,t,n){var r=v,a=g,u=i,l=o;0==e&&(r=r+s+i,a+=s,u=s),1==e&&(r=r,a+=s,u=s),2==e&&(r+=s,a=a-o+s,u=i,l=s),3==e&&(r+=s+i,a=a-o+s,u=i,l=s),4==e&&(r+=s,a+=s),5==e&&(r=r+2*s+i,a+=s),a=j-a;var c=r/b,p=a/j-o/j;part=[new THREE.Vector2(c,p+l/j),new THREE.Vector2(c,p),new THREE.Vector2(c+u/b,p),new THREE.Vector2(c+u/b,p+l/j)],f.faceVertexUvs[0][t]=[part[0],part[1],part[3]],f.faceVertexUvs[0][n]=[part[1],part[2],part[3]]}f=new THREE.BoxGeometry(i,o,s,1,1,1),a&&w?d=new THREE.MeshBasicMaterial({color:0,wireframe:!0}):(d=new THREE.MeshBasicMaterial({color:0,wireframe:!0}),d=new THREE.MeshLambertMaterial({map:T,opacity:1,overdraw:0}),d.overdraw=1),R(0,2,3),R(1,0,1),R(2,4,5),R(3,6,7),R(4,10,11),R(5,8,9),f.applyMatrix((new THREE.Matrix4).makeTranslation(i/2+E,-(m+o/2),s/2+h));var y=new THREE.Mesh(f,d);y.position.x=t,y.position.y=n,y.position.z=r,y.rotation.order="ZYX",y.rotation.z=-Math.radians(c),y.rotation.y=Math.radians(l),y.rotation.x=-Math.radians(u),y.textureObj=T,y.cubename=e,p.add(y)}var r=jQuery(e);jQuery(e).bind("mousewheel",function(e){e.originalEvent.wheelDelta<0?l--:l++,e.preventDefault()}),jQuery(document).bind("keyup",function(e){87==e.which&&(w=!w,v=m.length)}),jQuery(e).bind("mouseup",function(t){var n=new THREE.Vector3(t.clientX/jQuery(e).width()*2-1,2*-(t.clientY/jQuery(e).height())+1,.5);g.unprojectVector(n,c);var r=new THREE.Raycaster(c.position,n.sub(c.position).normalize()),a=[];p.traverse(function(e){e instanceof THREE.Mesh&&a.push(e)});var i=r.intersectObjects(a);if(i.length>0){var o=i[0].object;jQuery(".string:contains('"+o.cubename+"')")[0].scrollIntoView(!0),jQuery(document).scrollTop(0)}}),jQuery(document).bind("mousemove",e,function(e){H&&(R=e.pageX)}),c=new THREE.PerspectiveCamera(75,r.width()/r.height(),1,1e4),c.position.z=1e3,p=new THREE.Scene,t(0,3),t(0,-3),t(3,0),t(-3,0);var a=!0;if(null!=u.file("texture.png")){a=!1;var i=String.fromCharCode.apply(null,new Uint16Array(u.file("texture.png").asUint8Array())),h=window.btoa(i),y="data:image/png;base64,"+h,M=new Image;M.onload=function(){T.image=M,T.wrapS=THREE.RepeatWrapping,T.wrapT=THREE.RepeatWrapping,T.magFilter=THREE.NearestFilter,T.minFilter=THREE.NearestFilter,T.needsUpdate=!0},M.src=y}for(var b=o,j=s,x=0;x<m.length;x++){var Q=m[x];n(Q.name,Q.position[0],-Q.position[1],Q.position[2],Q.dimensions[0],Q.dimensions[1],Q.dimensions[2],Q.rotation[0],Q.rotation[1],Q.rotation[2],Q.offset[0],Q.offset[1],Q.offset[2],Q.txOffset[0],Q.txOffset[1])}var z={antialias:!0};E=new THREE.WebGLRenderer(z),E.setClearColor(15856113,1),E.setSize(r.width(),r.height());var V=jQuery(E.domElement);jQuery(e).append(V)}function i(){requestAnimationFrame(i),p.traverse(function(e){e instanceof THREE.Mesh&&(w?v>0&&(e.material=null,e.material=new THREE.MeshBasicMaterial({color:0,wireframe:!0}),e.material.needsUpdate=!0,v--):v>0&&(v--,e.material=new THREE.MeshLambertMaterial({map:T,opacity:1,overdraw:0})))});var e=l,t=3.2;h-=.002,H&&(y>R?h+=.005:h-=.005),c.position.y=15,c.position.x=p.position.x+e*Math.cos(t*h),c.position.z=p.position.z+e*Math.sin(t*h),c.lookAt(p.position),E.render(p,c)}if(t)throw t;var o,s,u=new JSZip(n),l=30;Math.degrees=function(e){return 180*e/Math.PI},Math.radians=function(e){return e*(Math.PI/180)};var c,p,E,f,d,m=[],h=30,w=!1,v=0,T=new THREE.Texture,g=new THREE.Projector;jQuery(function(){var e=u.file("model.json").asText(),t=JSON.parse(e);jQuery("#statspanel").html(r(t));$.each(t,function(e,t){"cubes"==e&&$.each(t,function(e,t){m.push(t)}),"textureWidth"==e&&(o=t),"textureHeight"==e&&(s=t)}),setTimeout(function(){a(),i()},100)});var R=-1,y=-1,H=!1})}},Tabula=new tbl;
